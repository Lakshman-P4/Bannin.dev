<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bannin Analytics</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" integrity="sha384-vsrfeLOOY6KuIYKDlmVH5UiBmgIdB1oEf7p01YgWHuqmOHfZr374+odEv96n9tNC" crossorigin="anonymous"></script>
<style>
:root {
  --bg: #0a0a0f;
  --card: rgba(255,255,255,0.04);
  --card-border: rgba(255,255,255,0.08);
  --text: #e0e0e8;
  --text-dim: #8888a0;
  --accent: #6ee7b7;
  --amber: #fbbf24;
  --red: #ef4444;
  --blue: #60a5fa;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 24px;
}
header {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 24px;
}
header h1 {
  font-size: 24px;
  font-weight: 600;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.stats-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}
.stat-chip {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 8px;
  padding: 8px 16px;
  font-size: 13px;
}
.stat-chip .value { font-weight: 600; color: var(--accent); }
.search-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
}
.search-bar input {
  flex: 1;
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 8px;
  padding: 10px 16px;
  color: var(--text);
  font-size: 14px;
  outline: none;
}
.search-bar input:focus { border-color: var(--accent); }
.search-bar button {
  background: var(--accent);
  color: #0a0a0f;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
}
.search-bar button:hover { opacity: 0.9; }
nav.filters {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.filter-btn {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 6px;
  padding: 6px 14px;
  color: var(--text-dim);
  font-size: 12px;
  cursor: pointer;
}
.filter-btn.active { border-color: var(--accent); color: var(--accent); }
.filter-btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 24px;
}
.card {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 12px;
  padding: 20px;
  backdrop-filter: blur(10px);
}
.card h3 {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-dim);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.card canvas { width: 100% !important; height: 200px !important; }
section.timeline {
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 12px;
  padding: 20px;
}
section.timeline h3 {
  font-size: 14px;
  font-weight: 500;
  color: var(--text-dim);
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.event-row {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  font-size: 13px;
}
.event-row:last-child { border-bottom: none; }
.event-time {
  color: var(--text-dim);
  font-size: 12px;
  min-width: 140px;
  font-family: monospace;
}
.event-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
  min-width: 70px;
  text-align: center;
}
.badge-critical { background: rgba(239,68,68,0.2); color: var(--red); }
.badge-warning { background: rgba(251,191,36,0.2); color: var(--amber); }
.badge-info { background: rgba(96,165,250,0.2); color: var(--blue); }
.badge-default { background: rgba(255,255,255,0.06); color: var(--text-dim); }
.event-type {
  color: var(--text-dim);
  font-size: 11px;
  font-family: monospace;
  min-width: 120px;
}
.event-msg { color: var(--text); flex: 1; }
.empty-state {
  text-align: center;
  padding: 40px;
  color: var(--text-dim);
}
.error-banner {
  background: rgba(239,68,68,0.15);
  border: 1px solid rgba(239,68,68,0.3);
  border-radius: 8px;
  padding: 10px 16px;
  margin-bottom: 16px;
  color: var(--red);
  font-size: 13px;
  display: none;
}
@media (max-width: 768px) {
  .grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<header>
  <h1>Bannin Analytics</h1>
</header>

<div class="error-banner" id="error-banner" role="alert" aria-live="polite"></div>

<div class="stats-bar" id="stats-bar" role="status" aria-live="polite" aria-label="Analytics statistics"></div>

<div class="search-bar" role="search">
  <input type="text" id="search-input" placeholder="Search events... (e.g., RAM, OOM, Chrome, model loaded)" aria-label="Search events">
  <button id="search-btn" type="button" aria-label="Search">Search</button>
</div>

<nav class="filters" aria-label="Event type filters">
  <button class="filter-btn active" data-filter="all" aria-pressed="true" type="button">All</button>
  <button class="filter-btn" data-filter="alert" aria-pressed="false" type="button">Alerts</button>
  <button class="filter-btn" data-filter="metric_snapshot" aria-pressed="false" type="button">Metrics</button>
  <button class="filter-btn" data-filter="llm_call" aria-pressed="false" type="button">LLM Calls</button>
  <button class="filter-btn" data-filter="mcp_tool_call" aria-pressed="false" type="button">MCP</button>
  <button class="filter-btn" data-filter="ollama" aria-pressed="false" type="button">Ollama</button>
  <button class="filter-btn" data-filter="session_start" aria-pressed="false" type="button">Sessions</button>
</nav>

<div class="grid">
  <section class="card" aria-label="System metrics chart">
    <h3>System Metrics (Last Hour)</h3>
    <canvas id="metrics-chart" role="img" aria-label="CPU and RAM usage over the last hour"></canvas>
  </section>
  <section class="card" aria-label="LLM cost chart">
    <h3>LLM Cost (Last 7 Days)</h3>
    <canvas id="cost-chart" role="img" aria-label="LLM cost trend over the last 7 days"></canvas>
  </section>
</div>

<section class="timeline" aria-label="Event timeline">
  <h3>Event Timeline</h3>
  <div id="timeline-content" aria-live="polite">
    <div class="empty-state">Loading events...</div>
  </div>
</section>

<script>
(function() {
"use strict";

const API = window.location.origin;
let currentFilter = 'all';
let metricsChart = null;
let costChart = null;
let refreshInterval = null;

function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

async function fetchJSON(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    hideError();
    return await res.json();
  } catch (e) {
    showError('Connection lost. Retrying...');
    return null;
  }
}

function showError(msg) {
  const el = document.getElementById('error-banner');
  el.textContent = msg;
  el.style.display = 'block';
}

function hideError() {
  const el = document.getElementById('error-banner');
  el.style.display = 'none';
}

function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  if (isNaN(d.getTime())) return '';
  return d.toLocaleString(undefined, { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

function severityBadge(sev) {
  const SAFE_SEV = { critical: 'badge-critical', warning: 'badge-warning', info: 'badge-info' };
  const cls = SAFE_SEV[sev] || 'badge-default';
  return '<span class="event-badge ' + cls + '">' + esc(sev || '-') + '</span>';
}

async function loadStats() {
  const data = await fetchJSON(API + '/stats');
  if (!data) return;

  const bar = document.getElementById('stats-bar');
  const totalEvents = esc(String((data.total_events || 0).toLocaleString()));
  const dbSize = esc(String(data.db_size_mb || 0));
  const fts = data.fts_available ? 'Yes' : 'No';
  let html = '<div class="stat-chip">Total Events: <span class="value">' + totalEvents + '</span></div>'
    + '<div class="stat-chip">DB Size: <span class="value">' + dbSize + ' MB</span></div>'
    + '<div class="stat-chip">FTS5: <span class="value">' + esc(fts) + '</span></div>';
  if (data.oldest_event) {
    html += '<div class="stat-chip">Since: <span class="value">' + esc(formatTime(data.oldest_event)) + '</span></div>';
  }
  bar.innerHTML = html;
}

async function loadTimeline() {
  const container = document.getElementById('timeline-content');
  let url = API + '/timeline?since=24h&limit=200';

  if (currentFilter !== 'all') {
    if (currentFilter === 'ollama') {
      url += '&types=ollama_model_load,ollama_model_unload';
    } else if (currentFilter === 'session') {
      url += '&types=session_start,session_stop';
    } else {
      url += '&types=' + encodeURIComponent(currentFilter);
    }
  }

  const data = await fetchJSON(url);
  if (!data || !data.timeline || data.timeline.length === 0) {
    container.innerHTML = '<div class="empty-state">No events found for this filter.</div>';
    return;
  }

  container.innerHTML = data.timeline.map(function(e) {
    return '<div class="event-row">'
      + '<span class="event-time">' + esc(formatTime(e.timestamp)) + '</span>'
      + severityBadge(e.severity)
      + '<span class="event-type">' + esc(e.type || '') + '</span>'
      + '<span class="event-msg">' + esc(e.message || '') + '</span>'
      + '</div>';
  }).join('');
}

async function loadMetricsChart() {
  const data = await fetchJSON(API + '/events?type=metric_snapshot&since=1h&limit=100');
  if (!data || !data.events || data.events.length === 0) return;

  const events = data.events.reverse();
  const labels = events.map(function(e) {
    const d = new Date(e.timestamp);
    return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
  });
  const cpuData = events.map(function(e) { return (e.data || {}).cpu_percent || 0; });
  const ramData = events.map(function(e) { return (e.data || {}).ram_percent || 0; });

  const ctx = document.getElementById('metrics-chart').getContext('2d');
  if (metricsChart) metricsChart.destroy();

  metricsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        { label: 'CPU %', data: cpuData, borderColor: '#60a5fa', backgroundColor: 'rgba(96,165,250,0.1)', fill: true, tension: 0.3, pointRadius: 0 },
        { label: 'RAM %', data: ramData, borderColor: '#6ee7b7', backgroundColor: 'rgba(110,231,183,0.1)', fill: true, tension: 0.3, pointRadius: 0 },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#8888a0', font: { size: 11 } } } },
      scales: {
        x: { ticks: { color: '#8888a0', font: { size: 10 }, maxTicksLimit: 8 }, grid: { color: 'rgba(255,255,255,0.04)' } },
        y: { min: 0, max: 100, ticks: { color: '#8888a0', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } }
      }
    }
  });
}

async function loadCostChart() {
  const data = await fetchJSON(API + '/cost?days=7');
  if (!data || !data.cost_trend || data.cost_trend.length === 0) {
    const ctx = document.getElementById('cost-chart').getContext('2d');
    if (costChart) costChart.destroy();
    costChart = new Chart(ctx, {
      type: 'bar',
      data: { labels: ['No data'], datasets: [{ label: 'Cost ($)', data: [0], backgroundColor: 'rgba(110,231,183,0.3)' }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#8888a0' }, grid: { display: false } }, y: { ticks: { color: '#8888a0' }, grid: { color: 'rgba(255,255,255,0.04)' } } } }
    });
    return;
  }

  const labels = data.cost_trend.map(function(d) { return d.day; });
  const costs = data.cost_trend.map(function(d) { return d.total_cost || 0; });

  const ctx = document.getElementById('cost-chart').getContext('2d');
  if (costChart) costChart.destroy();

  costChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Cost ($)',
        data: costs,
        backgroundColor: 'rgba(110,231,183,0.4)',
        borderColor: '#6ee7b7',
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#8888a0', font: { size: 10 } }, grid: { display: false } },
        y: { ticks: { color: '#8888a0', font: { size: 10 }, callback: function(v) { return '$' + v.toFixed(2); } }, grid: { color: 'rgba(255,255,255,0.04)' } }
      }
    }
  });
}

function setFilter(filter, btn) {
  currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(function(b) {
    b.classList.remove('active');
    b.setAttribute('aria-pressed', 'false');
  });
  btn.classList.add('active');
  btn.setAttribute('aria-pressed', 'true');
  loadTimeline();
}

async function doSearch() {
  const q = document.getElementById('search-input').value.trim();
  if (!q) { loadTimeline(); return; }

  const container = document.getElementById('timeline-content');
  const data = await fetchJSON(API + '/search?q=' + encodeURIComponent(q) + '&limit=100');
  if (!data || !data.results || data.results.length === 0) {
    container.innerHTML = '<div class="empty-state">No results for "' + esc(q) + '"</div>';
    return;
  }

  container.innerHTML = data.results.map(function(e) {
    return '<div class="event-row">'
      + '<span class="event-time">' + esc(formatTime(e.timestamp)) + '</span>'
      + severityBadge(e.severity)
      + '<span class="event-type">' + esc(e.type || '') + '</span>'
      + '<span class="event-msg">' + esc(e.message || '') + '</span>'
      + '</div>';
  }).join('');
}

// Event delegation for filter buttons
document.querySelector('nav.filters').addEventListener('click', function(e) {
  const btn = e.target.closest('.filter-btn');
  if (!btn) return;
  setFilter(btn.dataset.filter, btn);
});

// Search button and Enter key
document.getElementById('search-btn').addEventListener('click', doSearch);
document.getElementById('search-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') doSearch();
});

// Lifecycle: pause polling when tab is hidden
function startPolling() {
  loadStats();
  loadTimeline();
  loadMetricsChart();
  loadCostChart();
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(function() {
    loadStats();
    loadTimeline();
    loadMetricsChart();
  }, 30000);
}

document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; }
  } else {
    startPolling();
  }
});

startPolling();

})();
</script>
</body>
</html>
